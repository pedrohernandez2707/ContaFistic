import{a as q,Q as Me}from"./QBreadcrumbs.304da429.js";import{d as me,g as u,_ as ve,o as y,aF as be,w as i,e as o,l as D,i as R,j as I,C as K,aG as oe,aH as W,Q as Z,aM as Pe,bp as $e,bq as ze,f as d,q as te,r as Ue,P as G,a as T,bl as Ae,ba as Le,x as M,aq as le,c as P,aJ as ne,aK as se}from"./index.a62a34ef.js";import{h as H}from"./QSelect.7023c637.js";import{r as Je,u as xe,Q as re,a as ie,b as je}from"./xlsx.0d36ec1d.js";import{Q as de,C as ue}from"./ClosePopup.a526deb2.js";import{Q as fe,a as X}from"./QTable.fcbcbb6b.js";import{Q as Oe}from"./QPage.3c34c3f3.js";import{a as B,s as w,c as ce,b as Ye}from"./axios.0012f664.js";import{Q as qe,a as Ge}from"./QBar.f7b98df9.js";import"./selection.1e56649a.js";import"./use-render-cache.3aae9b27.js";import"./QList.2531dbd7.js";const He=me({name:"BuscadorVentas",emits:["venta-seleccionada"],setup(e,{emit:r}){const h=u(null),g=u(!1),V=u(""),N=[{name:"empresa",label:"Empresa",align:"left",field:"nombre_empresa",sortable:!0},{name:"venta",label:"Venta",align:"left",field:"id_venta",sortable:!0},{name:"poliza",label:"Poliza",align:"left",field:"id_poliza",sortable:!0},{name:"descripcion",label:"Descripci\xF3n",align:"left",field:"descripcion",sortable:!0}],c=u([]),l=u([...c.value]),b=()=>{V.value===null?l.value=c.value:l.value=c.value.filter(v=>v.id_compra.toLowerCase().includes(V.value)||v.descripcion||v.nombre_empresa||v.id_poliza.toLowerCase().includes(V.value.toLowerCase()))},$=(v,S)=>{g.value=!1,r("venta-seleccionada",S.id_venta)},z=()=>{g.value=!1},U=async()=>{var v;g.value=!0,await new Promise(S=>setTimeout(S,250)),(v=h.value)==null||v.focus(),A()},A=()=>{B.get("ventas",{params:{id_empresa:3,id_periodo:1}}).then(v=>{c.value=v.data,l.value=v.data})};return{refInputBuscar:h,dialogVisible:g,searchQuery:V,columns:N,ventas:c,filteredVentas:l,filtrarVentas:b,seleccionarVenta:$,cerrarDialogo:z,abrirDialogo:U}}}),Re=e=>($e("data-v-473e3052"),e=e(),ze(),e),Ke=Re(()=>d("div",{class:"text-h6"},"Buscador",-1));function We(e,r,h,g,V,N){return y(),be(Pe,{modelValue:e.dialogVisible,"onUpdate:modelValue":r[1]||(r[1]=c=>e.dialogVisible=c),persistent:""},{default:i(()=>[o(Z,{style:{"min-width":"650px"}},{default:i(()=>[o(qe,null,{default:i(()=>[Ke,o(Ge),o(D,{dense:"",flat:"",icon:"close",onClick:e.cerrarDialogo},null,8,["onClick"])]),_:1}),o(R,null,{default:i(()=>[o(I,{modelValue:e.searchQuery,"onUpdate:modelValue":[r[0]||(r[0]=c=>e.searchQuery=c),e.filtrarVentas],ref:"refInputBuscar",label:"Buscar Libro Ventas",dense:"",outlined:"",clearable:"",debounce:"350"},{append:i(()=>[o(K,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),o(fe,{rows:e.filteredVentas,columns:e.columns,"row-key":"correlativo",style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",onRowDblclick:e.seleccionarVenta,dense:""},{"body-cell-correlativo":i(c=>[o(X,{props:c},{default:i(()=>[oe(W(c.row.correlativo),1)]),_:2},1032,["props"])]),"body-cell-nombre":i(c=>[o(X,{props:c},{default:i(()=>[oe(W(c.row.nombre),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","onRowDblclick"])]),_:1})]),_:1},8,["modelValue"])}var Ze=ve(He,[["render",We],["__scopeId","data-v-473e3052"]]);const F=new Date;F.getDate();F.getMonth()+1;F.getFullYear();F.setHours(0,-F.getTimezoneOffset(),0,0);let pe=F.toJSON().slice(0,10).replaceAll("-","/");const Xe=me({components:{BuscadorVentas:Ze},setup(){const e=u(null),r=()=>{var t;(t=e.value)==null||t.abrirDialogo()},h=u([]),g=u([]),V=u(null),N=u(""),c=u(!1),l=u(""),b=u(null),$=()=>{b.value=null,B.get("/cuentasn4/combo").then(t=>{h.value=t.data})},z=(t,a)=>{if(t===""){a(()=>{g.value=[...h.value]});return}const p=t.toLowerCase();a(()=>{g.value=h.value.filter(m=>m.descripcion.toLowerCase().includes(p))})},U=(t,a)=>{if(t===""){a(()=>{g.value=h.value});return}a(()=>{const p=t.toLowerCase();g.value=h.value.filter(m=>isNaN(p)?m.descripcion.toLowerCase().includes(p.toLowerCase()):m.descripcion.toLowerCase().startsWith(p.toString()))},p=>{t!==""&&p.options.length>0&&(p.setOptionIndex(-1),p.moveOptionSelection(1,!0))})},A=u(null),v=u(null),S=u(!1),ge=u([{id:1,nombre:"2024"}]),he=u([{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}]),L=u(null),Ve=u([]),_e=u(!1),J=u(pe),x=u(pe),f=u([{}]),Ce=[{name:"Doc",label:"Doc. No",field:"documento",align:"left"},{name:"Serie",label:"Serie",field:"serie",align:"left"},{name:"Fecha",label:"Fecha",field:"fecha",align:"left",sortable:!0},{name:"Tipo",label:"Tipo",field:"tipo",align:"left",style:"max-width:120px;width:100px;"},{name:"NIT",label:"NIT",field:"nit",align:"left",style:"min-width:100px;width:100px"},{name:"Comprador",label:"Comprador",field:"comprador",align:"left",style:"max-width:290px;width:290px;text-wrap:balance"},{name:"Cta",label:"Cta",field:"Cta",align:"left",style:"max-width:150px;width:150px"},{name:"Exportaciones",label:"Exportaciones",field:"exportaciones",align:"left"},{name:"Bienes",label:"Bienes",field:"bienes",align:"left"},{name:"Servicios",label:"Servicios",field:"servicios",align:"left"},{name:"Exentos",label:"Exentos",field:"Exentos",align:"left"},{name:"SubTotal",label:"SubTotal",field:"subtotal",align:"left"},{name:"Iva",label:"Iva",field:"iva",align:"left"}],we=t=>{f.value=f.value.filter(a=>a.documento!==t)},Se=()=>{f.value.push({documento:f.value.length+1})};function ye(t){const a=new Date(t),p=a.getFullYear(),m=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),_=String(a.getHours()).padStart(2,"0"),C=String(a.getMinutes()).padStart(2,"0"),O=String(a.getSeconds()).padStart(2,"0");return`${p}-${m}-${n} ${_}:${C}:${O}`}const De=async()=>{if(L.value){const t=await L.value.arrayBuffer(),a=Je(t),p=a.Sheets[a.SheetNames[0]],m=xe.sheet_to_json(p);let n=JSON.parse(G.getItem("empresa").toString()),_="",C="";n!==null&&(_=n.nit,C=n.distVentas);const Q=m.filter(s=>{if(_!==s["ID del receptor"])return s;w("Existen documentos con el mismo nit de la empresa seleccionada, verifique si no esta intentando cargar un archivo de compras!",{tipo:"negative",timeout:8500,progress:!0})}).map(s=>({documento:s["N\xFAmero del DTE"],serie:s.Serie,fecha:ye(s["Fecha de emisi\xF3n"]),tipo:s["Tipo de DTE (nombre)"],nit:s["ID del receptor"],comprador:s["Nombre completo del receptor"],bienes:C==="Bienes"?s["Monto (Gran Total)"]:"",servicios:C==="Servicios"?s["Monto (Gran Total)"]:"",subtotal:(s["Monto (Gran Total)"]-s["IVA (monto de este impuesto)"]).toFixed(2),iva:s["IVA (monto de este impuesto)"],Cta:null}));f.value=Q}return 0},j=u("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZ2VuY2lhVmlydHVhbERURSIsImlzcyI6IlNBVCIsIm5pdCI6IjEwNDkwOTUwMSIsImV4cCI6MTcyNDc3MjU3NiwiaWF0IjoxNzI0NzI5Mzc2fQ.1h1lDjyLsrL7ZH9inMvVZ9PHV-xtBsN6qVdPK0uHB54"),Ie=()=>{const t=ce.create();j.value===""&&t.get("http://localhost:5000/get-token").then(a=>{console.log(a.data),j.value=a.data}).catch(a=>console.error("Error:",a))},E=t=>{const[a,p,m]=t.split("/").map(Number),n=m.toString().padStart(2,"0"),_=p.toString().padStart(2,"0");return`${n}-${_}-${a}`},Fe=()=>{const t=ce.create();console.log(E(J.value),E(x.value)),t.get("http://localhost:5000/get-fact",{headers:{Authorization:j.value},params:{nit:"104909501",fechai:E(J.value),fechaf:E(x.value),tipo:"R"}}).then(a=>{const m=a.data.data.map(n=>({documento:n.numeroDocumento,serie:n.serie,fecha:n.fechaEmision,tipo:n.tipo,proveedor:n.nombreEmisor,nit:n.nitEmisor,total:n.granTotal,iva:n.totalIva}));console.log(m),f.value=m}).catch(a=>console.error("Error:",a))},Ne=t=>t.every(a=>a.Cta!==null),Be=async()=>{let t=!1;const a=JSON.parse(G.getItem("empresa").toString());let p=0;if(a)p=a.id;else{w("Debe Seleccionar Empresa",{tipo:"negative"}),t=!0;return}const m=v.value;if(!m){w("Debe Seleccionar el Mes",{tipo:"negative"}),t=!0;return}let n=V.value;if(!n){w("Debe Seleccionar la Cuenta Contable Para el Encabezado",{tipo:"negative"}),t=!0;return}if(f.value.length==0){w("Debe Ingresar al Menos un Detalle",{tipo:"negative"}),t=!0;return}if(!Ne(f.value)){w("Debe Indicar la cuenta contable para cada uno de los Detalles, verificar",{tipo:"negative"}),t=!0;return}let _=G.getItem("periodo");if(!_){w("Debe Seleccionar el Periodo para la Empresa Correspondiente",{tipo:"negative"}),t=!0;return}if(!t){let C=b.value;if(!await Ye("Confirmaci\xF3n","Esta seguro de "+(C!==null&&C!==""?"Actualizar libro de Ventas: "+C:"Insertar al libro de Ventas?"),{}))return;const Q=f.value.map(s=>({id:s.id,Cta:s.Cta,documento:s.documento,serie:s.serie,fecha:s.fecha,tipo:s.tipo,proveedor:s.proveedor,nit:s.nit,Importacion:s.Importacion,Servicios:s.Servicios,Exentos:s.Exentos,Valor:s.Valor,iva:s.iva,total:(isNaN(parseFloat(s.servicios))?0:parseFloat(s.servicios))+(isNaN(parseFloat(s.bienes))?0:parseFloat(s.bienes))}));if(b.value!=null){const s={_encabezado:[{_id_venta:b.value,_p_id_poliza:l.value,_id_cuenta_contable:n&&n.id?n.id:n,_usuario_ingresa:"usrtest",_estado:"A",_mes:v.value}],_detalle:Q};console.log(s),T.show(),await B.put("/ventas",s).then(k=>{console.log(k.data),w("Venta actualizada correctamente, Partida Actualizada",{}),S.value=!0}).finally(()=>{T.hide()})}else{const s={_encabezado:[{_id_Empresa:p,_mes:(m==null?void 0:m.id)||0,_periodo:_,_id_poliza:0,_id_cuenta_contable:n.id,_usuario_ingresa:"usrtest",_estado:"A"}],_detalle:Q};console.log(s),T.show(),await B.post("/ventas",s).then(k=>{console.log(k.data);const ke=k.data.fn_insertar_ventas_json,[ae,Y]=ke.replace(/[()]/g,"").split(","),Te=parseInt(ae);Y.replace(/"/g,""),w(`Venta guardada correctamente No.${ae} Partida Generada ${Y}`,{}),b.value=Te.toString(),l.value=Y.toString(),c.value=!0,S.value=!0}).finally(()=>{T.hide()})}}},Ee=te(()=>f.value.reduce((t,a)=>t+parseFloat(a.total||0),0).toFixed(2)),Qe=te(()=>f.value.reduce((t,a)=>t+parseFloat(a.iva||0),0).toFixed(2));function ee(t){const a=t.replace(/[\$,]/g,"");return parseFloat(a)}return{filterCuentas:z,file:L,parsedCSV:Ve,visibleDate:_e,fechai:J,fechaf:x,convert:De,columns:Ce,ventas:f,getdata:Ie,getFacturas:Fe,eliminarFila:we,agregarFila:Se,calculoTotal:Ee,calculoIva:Qe,selectedCuentaEnc:V,cuentasn4:h,cuentasFilter:g,filterCuenta:U,getCuentasN4:$,cantFacturas:N,txtNoPartida:l,checkPartidaGenerada:c,txtNoVenta:b,mesesDelA\u00F1o:he,periodoModel:A,mesesModel:v,periodos:ge,disableBTN:S,onClick:Be,onBuscarVenta:t=>{B.get("ventas/idVenta",{params:{id_venta:t}}).then(a=>{console.log(a.data),b.value=t,v.value=a.data.enc.mes,V.value=a.data.enc.id_cuenta_contable,l.value=a.data.enc.id_poliza;let m=a.data.det.map(n=>({id:1,Cta:{id:n.id_cuenta,correlativo:n.correlativo,nombre:n.nombre},documento:n.doc_no,serie:n.serie,fecha:n.fecha,tipo:n.tipo_documento,proveedor:n.proveedor,nit:n.nit_cedula,checked:!1,Importacion:n.importaciones,Servicios:n.servicios,Exentos:n.exentos,Valor:n.valor,total:ee(n.total),iva:ee(n.iva)}));f.value=m})},refBuscadorVentas:e,showBuscarVentas:r}},mounted(){this.getCuentasN4(),this.getdata()}}),ea={class:"row q-col-gutter-sm"},aa={class:"col-4"},oa={class:"col-4"},ta={class:"col-1"},la={class:"col-4"},na={class:"col-2"},sa={class:"col-3 text-right"},ra={class:"col-3"},ia={class:"col-12"},da={class:"col-12"},ua={class:"row q-col-gutter-sm"},ca={class:"col-5"},pa={class:"row items-center justify-end"},ma={class:"col-5"},va={class:"row items-center justify-end"},ba={class:"col-2"},fa={class:"col-12"},ga={class:"row q-ma-sm"},ha=d("div",{class:"col-9"},[d("div",{class:"text-h6"},"Detalle de Ventas")],-1),Va=d("div",{class:"col-1"},null,-1),_a={class:"col"},Ca={class:"table table-bordered",id:"preview-table"};function wa(e,r,h,g,V,N){const c=Ue("buscador-ventas");return y(),be(Oe,{padding:""},{default:i(()=>[o(Me,null,{default:i(()=>[o(q,{label:"Registros Contables",icon:"home"}),o(q,{label:"Ingreso",icon:"widgets"}),o(q,{label:"Libro Ventas",icon:"navigation"})]),_:1}),o(Z,{class:"q-mt-md"},{default:i(()=>[o(R,null,{default:i(()=>[d("div",ea,[d("div",aa,[o(I,{modelValue:e.txtNoVenta,"onUpdate:modelValue":r[0]||(r[0]=l=>e.txtNoVenta=l),type:"text",label:"No. Interno",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),d("div",oa,[o(H,{modelValue:e.mesesModel,"onUpdate:modelValue":r[1]||(r[1]=l=>e.mesesModel=l),options:e.mesesDelA\u00F1o,label:"Mes",outlined:"",dense:"","option-value":"id","option-label":"nombre",disable:e.txtNoVenta!=null},null,8,["modelValue","options","disable"])]),d("div",ta,[o(D,{color:"primary",outline:"",icon:"search",onClick:e.showBuscarVentas},null,8,["onClick"])]),d("div",la,[o(H,{modelValue:e.selectedCuentaEnc,"onUpdate:modelValue":r[2]||(r[2]=l=>e.selectedCuentaEnc=l),options:e.cuentasFilter,label:"Cuenta Debe",outlined:"",dense:"","option-value":"id","option-label":"descripcion","use-input":"","input-debounce":"300",onFilter:e.filterCuentas,clearable:""},null,8,["modelValue","options","onFilter"])]),d("div",na,[o(I,{modelValue:e.cantFacturas,"onUpdate:modelValue":r[3]||(r[3]=l=>e.cantFacturas=l),type:"text",label:"Cant. Facturas",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),d("div",sa,[o(Ae,{"left-label":"",modelValue:e.checkPartidaGenerada,"onUpdate:modelValue":r[4]||(r[4]=l=>e.checkPartidaGenerada=l),label:"Partida generada",disable:!0},null,8,["modelValue"])]),d("div",ra,[o(I,{modelValue:e.txtNoPartida,"onUpdate:modelValue":r[5]||(r[5]=l=>e.txtNoPartida=l),type:"text",label:"No.Partida",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),d("div",ia,[o(Le,{modelValue:e.visibleDate,"onUpdate:modelValue":r[6]||(r[6]=l=>e.visibleDate=l),label:"Consultar SAT"},null,8,["modelValue"])]),d("div",da,[o(de,null,{default:i(()=>[M(d("div",ua,[d("div",ca,[o(I,{dense:"",outlined:"",modelValue:e.fechai,"onUpdate:modelValue":r[8]||(r[8]=l=>e.fechai=l),mask:"date",rules:["date"],label:"Fecha Inicial","hide-bottom-space":"",placeholder:"YYYY/MM/DD",clearable:""},{append:i(()=>[o(K,{name:"event",class:"cursor-pointer"},{default:i(()=>[o(re,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:i(()=>[o(ie,{modelValue:e.fechai,"onUpdate:modelValue":r[7]||(r[7]=l=>e.fechai=l)},{default:i(()=>[d("div",pa,[M(o(D,{label:"Cerrar",color:"primary",flat:""},null,512),[[ue]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),d("div",ma,[o(I,{dense:"",outlined:"",modelValue:e.fechaf,"onUpdate:modelValue":r[10]||(r[10]=l=>e.fechaf=l),mask:"date",rules:["date"],"hide-bottom-space":"",label:"Fecha Final",placeholder:"YYYY/MM/DD",clearable:""},{append:i(()=>[o(K,{name:"event",class:"cursor-pointer"},{default:i(()=>[o(re,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:i(()=>[o(ie,{modelValue:e.fechaf,"onUpdate:modelValue":r[9]||(r[9]=l=>e.fechaf=l)},{default:i(()=>[d("div",va,[M(o(D,{label:"Cerrar",color:"primary",flat:""},null,512),[[ue]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),d("div",ba,[o(D,{color:"primary",label:"Consultar",onClick:e.getFacturas},null,8,["onClick"])])],512),[[le,e.visibleDate]])]),_:1})]),d("div",fa,[o(de,null,{default:i(()=>[M(o(je,{modelValue:e.file,"onUpdate:modelValue":[r[11]||(r[11]=l=>e.file=l),e.convert],label:"Seleccione o arraste un archivo para importar(.xls)",outlined:"",accept:".xls",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),[[le,!e.visibleDate]])]),_:1})])])]),_:1})]),_:1}),o(Z,{class:"q-mt-sm"},{default:i(()=>[o(R,null,{default:i(()=>[d("div",ga,[ha,Va,d("div",_a,[o(D,{color:"primary",icon:"check",label:e.txtNoVenta?"Actualizar Partida":"Generar Partida",onClick:e.onClick,disable:e.disableBTN},null,8,["label","onClick","disable"])])]),o(fe,{style:{height:"500px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",rows:e.ventas,columns:e.columns,"row-key":"id",dense:""},{"body-cell-Cta":i(l=>[o(X,{props:l},{default:i(()=>[o(H,{modelValue:l.row.Cta,"onUpdate:modelValue":b=>l.row.Cta=b,options:e.cuentasFilter,"option-label":"descripcion","option-value":"id",dense:"",borderless:"","map-options":"","hide-selected":"","hide-bottom-space":"","use-input":"","fill-input":"",clearable:"",onFilter:e.filterCuenta,onFilterAbort:()=>{}},null,8,["modelValue","onUpdate:modelValue","options","onFilter"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"]),d("table",Ca,[d("tbody",null,[(y(!0),P(se,null,ne(e.parsedCSV,l=>(y(),P("tr",null,[(y(!0),P(se,null,ne(l,b=>(y(),P("td",null,W(b),1))),256))]))),256))])])]),_:1})]),_:1}),o(c,{ref:"refBuscadorVentas",onVentaSeleccionada:e.onBuscarVenta},null,8,["onVentaSeleccionada"])]),_:1})}var $a=ve(Xe,[["render",wa]]);export{$a as default};
