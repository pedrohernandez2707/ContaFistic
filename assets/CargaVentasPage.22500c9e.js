import{a as q,Q as Be}from"./QBreadcrumbs.4144acfc.js";import{d as ce,g as d,_ as me,o as S,aF as pe,w as r,e as a,l as D,i as G,j as I,C as O,aG as ee,aH as H,Q as R,aM as ke,bp as Ee,bq as Te,f as i,q as ae,r as Pe,P as oe,a as P,bl as Me,ba as $e,x as M,aq as le,c as $,aJ as te,aK as ne}from"./index.e60fa00d.js";import{h as L}from"./QSelect.70b07cba.js";import{r as ze,u as Ue,Q as se,a as re,b as Ae}from"./xlsx.d96f9f67.js";import{Q as ie,C as de}from"./ClosePopup.6b3536ad.js";import{Q as ve,a as x}from"./QTable.bfefe082.js";import{Q as je}from"./QPage.b16c688f.js";import{a as k,c as ue,s as h,b as Je}from"./axios.a61b5a41.js";import{Q as Ye,a as qe}from"./QBar.59ae0d55.js";import"./selection.21886ae7.js";import"./use-render-cache.3aae9b27.js";import"./QList.5561c62f.js";const Le=ce({name:"BuscadorVentas",emits:["venta-seleccionada"],setup(e,{emit:s}){const V=d(null),b=d(!1),g=d(""),C=[{name:"empresa",label:"Empresa",align:"left",field:"nombre_empresa",sortable:!0},{name:"venta",label:"Venta",align:"left",field:"id_venta",sortable:!0},{name:"poliza",label:"Poliza",align:"left",field:"id_poliza",sortable:!0},{name:"descripcion",label:"Descripci\xF3n",align:"left",field:"descripcion",sortable:!0}],u=d([]),o=d([...u.value]),_=()=>{g.value===null?o.value=u.value:o.value=u.value.filter(v=>v.id_compra.toLowerCase().includes(g.value)||v.descripcion||v.nombre_empresa||v.id_poliza.toLowerCase().includes(g.value.toLowerCase()))},z=(v,w)=>{b.value=!1,s("venta-seleccionada",w.id_venta)},y=()=>{b.value=!1},F=async()=>{var v;b.value=!0,await new Promise(w=>setTimeout(w,250)),(v=V.value)==null||v.focus(),U()},U=()=>{k.get("ventas",{params:{id_empresa:3,id_periodo:1}}).then(v=>{u.value=v.data,o.value=v.data})};return{refInputBuscar:V,dialogVisible:b,searchQuery:g,columns:C,ventas:u,filteredVentas:o,filtrarVentas:_,seleccionarVenta:z,cerrarDialogo:y,abrirDialogo:F}}}),Ge=e=>(Ee("data-v-473e3052"),e=e(),Te(),e),Oe=Ge(()=>i("div",{class:"text-h6"},"Buscador",-1));function He(e,s,V,b,g,C){return S(),pe(ke,{modelValue:e.dialogVisible,"onUpdate:modelValue":s[1]||(s[1]=u=>e.dialogVisible=u),persistent:""},{default:r(()=>[a(R,{style:{"min-width":"650px"}},{default:r(()=>[a(Ye,null,{default:r(()=>[Oe,a(qe),a(D,{dense:"",flat:"",icon:"close",onClick:e.cerrarDialogo},null,8,["onClick"])]),_:1}),a(G,null,{default:r(()=>[a(I,{modelValue:e.searchQuery,"onUpdate:modelValue":[s[0]||(s[0]=u=>e.searchQuery=u),e.filtrarVentas],ref:"refInputBuscar",label:"Buscar Libro Ventas",dense:"",outlined:"",clearable:"",debounce:"350"},{append:r(()=>[a(O,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),a(ve,{rows:e.filteredVentas,columns:e.columns,"row-key":"correlativo",style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",onRowDblclick:e.seleccionarVenta,dense:""},{"body-cell-correlativo":r(u=>[a(x,{props:u},{default:r(()=>[ee(H(u.row.correlativo),1)]),_:2},1032,["props"])]),"body-cell-nombre":r(u=>[a(x,{props:u},{default:r(()=>[ee(H(u.row.nombre),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","onRowDblclick"])]),_:1})]),_:1},8,["modelValue"])}var Re=me(Le,[["render",He],["__scopeId","data-v-473e3052"]]);const N=new Date;N.getDate();N.getMonth()+1;N.getFullYear();N.setHours(0,-N.getTimezoneOffset(),0,0);let K=N.toJSON().slice(0,10).replaceAll("-","/");console.log(K);const xe=ce({components:{BuscadorVentas:Re},setup(){const e=d(null),s=()=>{var n;(n=e.value)==null||n.abrirDialogo()},V=d([]),b=d(null),g=d(""),C=d(!1),u=d(""),o=d(null),_=()=>{o.value=null,k.get("/cuentasn4/QTable").then(n=>{V.value=n.data})},z=d(null),y=d(null),F=d(!1),U=d([{id:1,nombre:"2024"}]),v=d([{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}]),w=d(null),be=d([]),fe=d(!1),A=d(K),j=d(K),m=d([{}]),ge=[{name:"Doc",label:"Doc. No",field:"documento",align:"left"},{name:"Serie",label:"Serie",field:"serie",align:"left"},{name:"Fecha",label:"Fecha",field:"fecha",align:"left"},{name:"Tipo",label:"Tipo",field:"tipo",align:"left",style:"max-width:120px;width:100px;"},{name:"NIT",label:"NIT",field:"nit",align:"left"},{name:"Comprador",label:"Comprador",field:"comprador",align:"left"},{name:"Cta",label:"Cta",field:"Cta",align:"left",style:"max-width:150px;width:150px"},{name:"Exportaciones",label:"Exportaciones",field:"exportaciones",align:"left"},{name:"Bienes",label:"Bienes",field:"bienes",align:"left"},{name:"Servicios",label:"Servicios",field:"servicios",align:"left"},{name:"Exentos",label:"Exentos",field:"Exentos",align:"left"},{name:"Total",label:"Total",field:"total",align:"left"},{name:"Iva",label:"Iva",field:"iva",align:"left"}],he=n=>{m.value=m.value.filter(l=>l.documento!==n)},Ve=()=>{m.value.push({documento:m.value.length+1})};function _e(n){const l=new Date(n),f=l.getFullYear(),p=String(l.getMonth()+1).padStart(2,"0"),t=String(l.getDate()).padStart(2,"0"),c=String(l.getHours()).padStart(2,"0"),Q=String(l.getMinutes()).padStart(2,"0"),W=String(l.getSeconds()).padStart(2,"0");return`${f}-${p}-${t} ${c}:${Q}:${W}`}const we=async()=>{if(w.value){const n=await w.value.arrayBuffer(),l=ze(n),f=l.Sheets[l.SheetNames[0]],t=Ue.sheet_to_json(f).map(c=>({documento:c["N\xFAmero del DTE"],serie:c.Serie,fecha:_e(c["Fecha de emisi\xF3n"]),tipo:c["Tipo de DTE (nombre)"],nit:c["ID del receptor"],comprador:c["Nombre completo del receptor"],total:c["Monto (Gran Total)"],iva:c["IVA (monto de este impuesto)"],Cta:null}));m.value=t}return 0},J=d("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZ2VuY2lhVmlydHVhbERURSIsImlzcyI6IlNBVCIsIm5pdCI6IjEwNDkwOTUwMSIsImV4cCI6MTcyNDc3MjU3NiwiaWF0IjoxNzI0NzI5Mzc2fQ.1h1lDjyLsrL7ZH9inMvVZ9PHV-xtBsN6qVdPK0uHB54"),Ce=()=>{const n=ue.create();J.value===""&&n.get("http://localhost:5000/get-token").then(l=>{console.log(l.data),J.value=l.data}).catch(l=>console.error("Error:",l))},E=n=>{const[l,f,p]=n.split("/").map(Number),t=p.toString().padStart(2,"0"),c=f.toString().padStart(2,"0");return`${t}-${c}-${l}`},ye=()=>{const n=ue.create();console.log(E(A.value),E(j.value)),n.get("http://localhost:5000/get-fact",{headers:{Authorization:J.value},params:{nit:"104909501",fechai:E(A.value),fechaf:E(j.value),tipo:"R"}}).then(l=>{const p=l.data.data.map(t=>({documento:t.numeroDocumento,serie:t.serie,fecha:t.fechaEmision,tipo:t.tipo,proveedor:t.nombreEmisor,nit:t.nitEmisor,total:t.granTotal,iva:t.totalIva}));console.log(p),m.value=p}).catch(l=>console.error("Error:",l))},Se=n=>n.every(l=>l.Cta!==null),De=async()=>{let n=!1;const l=JSON.parse(oe.getItem("empresa").toString());let f=0;if(l)f=l.id;else{h("Debe Seleccionar Empresa",{tipo:"negative"}),n=!0;return}const p=y.value;if(!p){h("Debe Seleccionar el Mes",{tipo:"negative"}),n=!0;return}let t=b.value;if(!t){h("Debe Seleccionar la Cuenta Contable Para el Encabezado",{tipo:"negative"}),n=!0;return}if(m.value.length==0){h("Debe Ingresar al Menos un Detalle",{tipo:"negative"}),n=!0;return}if(!Se(m.value)){h("Debe Indicar la cuenta contable para cada uno de los Detalles, verificar",{tipo:"negative"}),n=!0;return}let c=oe.getItem("periodo");if(!c){h("Debe Seleccionar el Periodo para la Empresa Correspondiente",{tipo:"negative"}),n=!0;return}if(!n){let Q=o.value;if(!await Je("Confirmaci\xF3n","Esta seguro de "+(Q!==null&&Q!==""?"Actualizar libro de Ventas: "+Q:"Insertar al libro de Ventas?"),{}))return;if(o.value!=null){const B={_encabezado:[{_id_venta:o.value,_p_id_poliza:u.value,_id_cuenta_contable:t&&t.id?t.id:t,_usuario_ingresa:"usrtest",_estado:"A",_mes:y.value}],_detalle:m.value};console.log(B),P.show(),await k.put("/ventas",B).then(T=>{console.log(T.data),h("Venta actualizada correctamente, Partida Actualizada",{}),F.value=!0}).finally(()=>{P.hide()})}else{const B={_encabezado:[{_id_Empresa:f,_mes:(p==null?void 0:p.id)||0,_periodo:c,_id_poliza:0,_id_cuenta_contable:t.id,_usuario_ingresa:"usrtest",_estado:"A"}],_detalle:m.value};console.log(B),P.show(),await k.post("/ventas",B).then(T=>{console.log(T.data);const Fe=T.data.fn_insertar_ventas_json,[X,Y]=Fe.replace(/[()]/g,"").split(","),Qe=parseInt(X);Y.replace(/"/g,""),h(`Venta guardada correctamente No.${X} Partida Generada ${Y}`,{}),o.value=Qe.toString(),u.value=Y.toString(),C.value=!0,F.value=!0}).finally(()=>{P.hide()})}}},Ie=ae(()=>m.value.reduce((n,l)=>n+parseFloat(l.total||0),0).toFixed(2)),Ne=ae(()=>m.value.reduce((n,l)=>n+parseFloat(l.iva||0),0).toFixed(2));function Z(n){const l=n.replace(/[\$,]/g,"");return parseFloat(l)}return{file:w,parsedCSV:be,visibleDate:fe,fechai:A,fechaf:j,convert:we,columns:ge,ventas:m,getdata:Ce,getFacturas:ye,eliminarFila:he,agregarFila:Ve,calculoTotal:Ie,calculoIva:Ne,selectedCuentaEnc:b,cuentasn4:V,getCuentasN4:_,cantFacturas:g,txtNoPartida:u,checkPartidaGenerada:C,txtNoVenta:o,mesesDelA\u00F1o:v,periodoModel:z,mesesModel:y,periodos:U,disableBTN:F,onClick:De,onBuscarVenta:n=>{k.get("ventas/idVenta",{params:{id_venta:n}}).then(l=>{console.log(l.data),o.value=n,y.value=l.data.enc.mes,b.value=l.data.enc.id_cuenta_contable,u.value=l.data.enc.id_poliza;let p=l.data.det.map(t=>({id:1,Cta:{id:t.id_cuenta,correlativo:t.correlativo,nombre:t.nombre},documento:t.doc_no,serie:t.serie,fecha:t.fecha,tipo:t.tipo_documento,proveedor:t.proveedor,nit:t.nit_cedula,checked:!1,Importacion:t.importaciones,Servicios:t.servicios,Exentos:t.exentos,Valor:t.valor,total:Z(t.total),iva:Z(t.iva)}));m.value=p})},refBuscadorVentas:e,showBuscarVentas:s}},mounted(){this.getCuentasN4(),this.getdata()}}),Ke={class:"row q-col-gutter-sm"},Ze={class:"col-4"},We={class:"col-4"},Xe={class:"col-1"},ea={class:"col-4"},aa={class:"col-2"},oa={class:"col-3 text-right"},la={class:"col-3"},ta={class:"col-12"},na={class:"col-12"},sa={class:"row q-col-gutter-sm"},ra={class:"col-5"},ia={class:"row items-center justify-end"},da={class:"col-5"},ua={class:"row items-center justify-end"},ca={class:"col-2"},ma={class:"col-12"},pa={class:"row q-ma-sm"},va=i("div",{class:"col-9"},[i("div",{class:"text-h6"},"Detalle de Ventas")],-1),ba=i("div",{class:"col-1"},null,-1),fa={class:"col"},ga={class:"table table-bordered",id:"preview-table"};function ha(e,s,V,b,g,C){const u=Pe("buscador-ventas");return S(),pe(je,{padding:""},{default:r(()=>[a(Be,null,{default:r(()=>[a(q,{label:"Registros Contables",icon:"home"}),a(q,{label:"Ingreso",icon:"widgets"}),a(q,{label:"Libro Ventas",icon:"navigation"})]),_:1}),a(R,{class:"q-mt-md"},{default:r(()=>[a(G,null,{default:r(()=>[i("div",Ke,[i("div",Ze,[a(I,{modelValue:e.txtNoVenta,"onUpdate:modelValue":s[0]||(s[0]=o=>e.txtNoVenta=o),type:"text",label:"No. Interno",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",We,[a(L,{modelValue:e.mesesModel,"onUpdate:modelValue":s[1]||(s[1]=o=>e.mesesModel=o),options:e.mesesDelA\u00F1o,label:"Mes",outlined:"",dense:"","option-value":"id","option-label":"nombre",disable:e.txtNoVenta!=null},null,8,["modelValue","options","disable"])]),i("div",Xe,[a(D,{color:"primary",outline:"",icon:"search",onClick:e.showBuscarVentas},null,8,["onClick"])]),i("div",ea,[a(L,{modelValue:e.selectedCuentaEnc,"onUpdate:modelValue":s[2]||(s[2]=o=>e.selectedCuentaEnc=o),options:e.cuentasn4,label:"Cuenta Debe",outlined:"",dense:"","option-value":"id","option-label":"nombre"},null,8,["modelValue","options"])]),i("div",aa,[a(I,{modelValue:e.cantFacturas,"onUpdate:modelValue":s[3]||(s[3]=o=>e.cantFacturas=o),type:"text",label:"Cant. Facturas",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",oa,[a(Me,{"left-label":"",modelValue:e.checkPartidaGenerada,"onUpdate:modelValue":s[4]||(s[4]=o=>e.checkPartidaGenerada=o),label:"Partida generada",disable:!0},null,8,["modelValue"])]),i("div",la,[a(I,{modelValue:e.txtNoPartida,"onUpdate:modelValue":s[5]||(s[5]=o=>e.txtNoPartida=o),type:"text",label:"No.Partida",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",ta,[a($e,{modelValue:e.visibleDate,"onUpdate:modelValue":s[6]||(s[6]=o=>e.visibleDate=o),label:"Consultar SAT"},null,8,["modelValue"])]),i("div",na,[a(ie,null,{default:r(()=>[M(i("div",sa,[i("div",ra,[a(I,{dense:"",outlined:"",modelValue:e.fechai,"onUpdate:modelValue":s[8]||(s[8]=o=>e.fechai=o),mask:"date",rules:["date"],label:"Fecha Inicial","hide-bottom-space":"",placeholder:"YYYY/MM/DD",clearable:""},{append:r(()=>[a(O,{name:"event",class:"cursor-pointer"},{default:r(()=>[a(se,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:r(()=>[a(re,{modelValue:e.fechai,"onUpdate:modelValue":s[7]||(s[7]=o=>e.fechai=o)},{default:r(()=>[i("div",ia,[M(a(D,{label:"Cerrar",color:"primary",flat:""},null,512),[[de]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),i("div",da,[a(I,{dense:"",outlined:"",modelValue:e.fechaf,"onUpdate:modelValue":s[10]||(s[10]=o=>e.fechaf=o),mask:"date",rules:["date"],"hide-bottom-space":"",label:"Fecha Final",placeholder:"YYYY/MM/DD",clearable:""},{append:r(()=>[a(O,{name:"event",class:"cursor-pointer"},{default:r(()=>[a(se,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:r(()=>[a(re,{modelValue:e.fechaf,"onUpdate:modelValue":s[9]||(s[9]=o=>e.fechaf=o)},{default:r(()=>[i("div",ua,[M(a(D,{label:"Cerrar",color:"primary",flat:""},null,512),[[de]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),i("div",ca,[a(D,{color:"primary",label:"Consultar",onClick:e.getFacturas},null,8,["onClick"])])],512),[[le,e.visibleDate]])]),_:1})]),i("div",ma,[a(ie,null,{default:r(()=>[M(a(Ae,{modelValue:e.file,"onUpdate:modelValue":[s[11]||(s[11]=o=>e.file=o),e.convert],label:"Seleccione o arraste un archivo para importar(.xls)",outlined:"",accept:".xls",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),[[le,!e.visibleDate]])]),_:1})])])]),_:1})]),_:1}),a(R,{class:"q-mt-sm"},{default:r(()=>[a(G,null,{default:r(()=>[i("div",pa,[va,ba,i("div",fa,[a(D,{color:"primary",icon:"check",label:e.txtNoVenta?"Actualizar Partida":"Generar Partida",onClick:e.onClick,disable:e.disableBTN},null,8,["label","onClick","disable"])])]),a(ve,{style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",rows:e.ventas,columns:e.columns,"row-key":"id",dense:""},{"body-cell-Cta":r(o=>[a(x,{props:o},{default:r(()=>[a(L,{modelValue:o.row.Cta,"onUpdate:modelValue":_=>o.row.Cta=_,options:e.cuentasn4,borderless:"",dense:"","options-dense":"","use-input":"","input-debounce":"0",class:"custom-select","option-value":"id","option-label":"nombre",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"]),i("table",ga,[i("tbody",null,[(S(!0),$(ne,null,te(e.parsedCSV,o=>(S(),$("tr",null,[(S(!0),$(ne,null,te(o,_=>(S(),$("td",null,H(_),1))),256))]))),256))])])]),_:1})]),_:1}),a(u,{ref:"refBuscadorVentas",onVentaSeleccionada:e.onBuscarVenta},null,8,["onVentaSeleccionada"])]),_:1})}var Ea=me(xe,[["render",ha]]);export{Ea as default};
