import{a as G,Q as Ue}from"./QBreadcrumbs.4144acfc.js";import{d as ue,g as d,_ as me,o as pe,aF as fe,w as o,e as a,l as _,i as R,j as I,C as H,aG as ee,aH as C,Q as L,aM as Ee,bp as be,bq as ve,f as i,q as ae,r as Be,P as le,a as U,bl as oe,ba as $e,x as E,aq as te}from"./index.e60fa00d.js";import{h as B}from"./QSelect.70b07cba.js";import{r as ze,u as Me,Q as se,a as ne,b as Ae}from"./xlsx.d96f9f67.js";import{Q as re,C as ie}from"./ClosePopup.6b3536ad.js";import{Q as ge,a as u}from"./QTable.bfefe082.js";import{Q as O}from"./QTr.42514221.js";import{Q as Je}from"./QPage.b16c688f.js";import{a as F,s as w,b as je,c as de}from"./axios.a61b5a41.js";import{Q as Ye,a as qe}from"./QBar.59ae0d55.js";import"./selection.21886ae7.js";import"./use-render-cache.3aae9b27.js";import"./QList.5561c62f.js";const Ge=ue({name:"BuscadorCompras",emits:["compra-seleccionada"],setup(e,{emit:r}){const y=d(null),g=d(!1),V=d(""),S=[{name:"empresa",label:"Empresa",align:"left",field:"nombre_empresa",sortable:!0},{name:"compra",label:"Compra",align:"left",field:"id_compra",sortable:!0},{name:"poliza",label:"Poliza",align:"left",field:"id_poliza",sortable:!0},{name:"descripcion",label:"Descripci\xF3n",align:"left",field:"descripcion",sortable:!0}],c=d([]),l=d([...c.value]),v=()=>{V.value===null?l.value=c.value:l.value=c.value.filter(f=>f.id_compra.toLowerCase().includes(V.value)||f.descripcion||f.nombre_empresa||f.id_poliza.toLowerCase().includes(V.value.toLowerCase()))},$=(f,T)=>{g.value=!1,r("compra-seleccionada",T.id_compra)},z=()=>{g.value=!1},k=async()=>{var f;g.value=!0,await new Promise(T=>setTimeout(T,250)),(f=y.value)==null||f.focus(),D()},D=()=>{F.get("compras",{params:{id_empresa:3,id_periodo:1}}).then(f=>{c.value=f.data,l.value=f.data})};return{refInputBuscar:y,dialogVisible:g,searchQuery:V,columns:S,compras:c,filteredCompras:l,filtrarCompras:v,seleccionarCompra:$,cerrarDialogo:z,abrirDialogo:k}}}),Oe=e=>(be("data-v-3d0f112b"),e=e(),ve(),e),Re=Oe(()=>i("div",{class:"text-h6"},"Buscador",-1));function He(e,r,y,g,V,S){return pe(),fe(Ee,{modelValue:e.dialogVisible,"onUpdate:modelValue":r[1]||(r[1]=c=>e.dialogVisible=c),persistent:""},{default:o(()=>[a(L,{style:{"min-width":"650px"}},{default:o(()=>[a(Ye,null,{default:o(()=>[Re,a(qe),a(_,{dense:"",flat:"",icon:"close",onClick:e.cerrarDialogo},null,8,["onClick"])]),_:1}),a(R,null,{default:o(()=>[a(I,{modelValue:e.searchQuery,"onUpdate:modelValue":[r[0]||(r[0]=c=>e.searchQuery=c),e.filtrarCompras],ref:"refInputBuscar",label:"Buscar Libro Compras",dense:"",outlined:"",clearable:"",debounce:"350"},{append:o(()=>[a(H,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),a(ge,{rows:e.filteredCompras,columns:e.columns,"row-key":"correlativo",style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",onRowDblclick:e.seleccionarCompra,dense:""},{"body-cell-correlativo":o(c=>[a(u,{props:c},{default:o(()=>[ee(C(c.row.correlativo),1)]),_:2},1032,["props"])]),"body-cell-nombre":o(c=>[a(u,{props:c},{default:o(()=>[ee(C(c.row.nombre),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","onRowDblclick"])]),_:1})]),_:1},8,["modelValue"])}var Le=me(Ge,[["render",He],["__scopeId","data-v-3d0f112b"]]);const x=new Date;x.setHours(0,-x.getTimezoneOffset(),0,0);let ce=x.toJSON().slice(0,10).replaceAll("-","/");const xe=ue({components:{BuscadorCompras:Le},setup(){const e=d(null),r=()=>{var n;(n=e.value)==null||n.abrirDialogo()},y=d([]),g=d(null),V=d(""),S=d(!1),c=d(""),l=d(null),v=d(null),$=()=>{l.value=null,F.get("/cuentasn4/QTable").then(n=>{y.value=n.data})},z=d(null),k=d(null),D=d(!1),f=d([{id:1,nombre:"2024"}]),T=d([{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}]),M=d(null),he=d([]),_e=d(!1),A=d(ce),J=d(ce),p=d([{}]),Ce=[{name:"Doc",label:"Doc. No",field:"documento",align:"left"},{name:"Serie",label:"Serie",field:"serie",align:"left"},{name:"Fecha",label:"Fecha",field:"fecha",align:"left"},{name:"Tipo",label:"Tipo",field:"tipo",align:"left",style:"min-width:120px;max-width:120px;width:120px;"},{name:"Proveedor",label:"Proveedor",field:"proveedor",align:"left",style:"width: auto;"},{name:"NIT",label:"NIT",field:"nit",align:"left"},{name:"Cta",label:"Cta",field:"Cta",align:"left",style:"max-width:150px;width:150px"},{name:"check",label:"Factura Pagada",field:"checked",align:"center"},{name:"Importacion",label:"Importacion",field:"Importacion",align:"left"},{name:"Compras",label:"Compras",field:"Compras",align:"left"},{name:"Servicios",label:"Servicios",field:"Servicios",align:"left"},{name:"Exentos",label:"Exentos",field:"Exentos",align:"left"},{name:"Valor",label:"Valor",field:"Valor",align:"left"},{name:"Total",label:"Total",field:"total",align:"left"},{name:"Iva",label:"Iva",field:"iva",align:"left"},{name:"acciones",label:"",field:"",align:"right",style:"width: 40px; padding:5px"}],Ve=n=>n.every(t=>t.Cta!==null),we=async()=>{let n=!1;const t=JSON.parse(le.getItem("empresa").toString());let h=0;if(t)h=t.id;else{w("Debe Seleccionar Empresa",{tipo:"negative"}),n=!0;return}const b=k.value;if(!b){w("Debe Seleccionar el Mes",{tipo:"negative"}),n=!0;return}const s=g.value;if(!s){w("Debe Seleccionar la Cuenta Contable Para el Encabezado",{tipo:"negative"}),n=!0;return}if(p.value.length==0){w("Debe Ingresar al Menos un Detalle",{tipo:"negative"}),n=!0;return}if(!Ve(p.value)){w("Debe Indicar la cuenta contable para cada uno de los Detalles, verificar",{tipo:"negative"}),n=!0;return}let m=le.getItem("periodo");if(!m){w("Debe Seleccionar el Periodo para la Empresa Correspondiente",{tipo:"negative"}),n=!0;return}if(!n){let Q=l.value;if(!await je("Confirmaci\xF3n","Esta seguro de "+(Q="Actualizar la Compra: "+Q),{}))return;if(l.value!=null){const Y={_encabezado:[{_id_compra:l.value,_id_cuenta_contable:s&&s.id?s.id:s,_usuario_ingresa:"usrtest",_estado:"A",_p_id_poliza:c.value,_mes:k.value}],_detalle:p.value};U.show(),await F.put("/compras",Y).then(P=>{console.log(P.data),P.data.fn_insertar_compras_json,w("Compra actualizada correctamente, Partida Actualizada",{}),D.value=!0}).finally(()=>{U.hide()})}else{const Y={_encabezado:[{_id_Empresa:h,_mes:(b==null?void 0:b.id)||0,_periodo:m,_id_poliza:0,_id_cuenta_contable:s.id,_usuario_ingresa:"usrtest",_estado:"A"}],_detalle:p.value};U.show(),await F.post("/compras",Y).then(P=>{const Qe=P.data.fn_insertar_compras_json,[Z,q]=Qe.replace(/[()]/g,"").split(","),Pe=parseInt(Z);q.replace(/"/g,""),w(`Compra guardada correctamente No.${Z} Partida Generada ${q}`,{}),l.value=Pe.toString(),c.value=q.toString(),S.value=!0,D.value=!0}).finally(()=>{U.hide()})}}},ye=async()=>{if(M.value){const n=await M.value.arrayBuffer(),t=ze(n),h=t.Sheets[t.SheetNames[0]],s=Me.sheet_to_json(h).map(m=>({documento:m["N\xFAmero del DTE"],serie:m.Serie,fecha:Ie(m["Fecha de emisi\xF3n"]),tipo:m["Tipo de DTE (nombre)"],proveedor:m["Nombre completo del emisor"],nit:m["NIT del emisor"],total:m["Monto (Gran Total)"],iva:m["IVA (monto de este impuesto)"],Cta:null,checked:!1}));p.value=s}return 0},j=d("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZ2VuY2lhVmlydHVhbERURSIsImlzcyI6IlNBVCIsIm5pdCI6IjEwNDkwOTUwMSIsImV4cCI6MTcyNTY0MTk1MywiaWF0IjoxNzI1NTk4NzUzfQ.2KE72Se31MWfXb3hVNJhluyAh2Fn6Vw-puz7UwbPoTk"),Se=()=>{const n=de.create();j.value===""&&(console.log("Hacer login sat"),n.get("http://localhost:5000/get-token").then(t=>{console.log(t.data),j.value=t.data}).catch(t=>console.error("Error:",t)))};function Ie(n){const t=new Date(n),h=t.getFullYear(),b=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),m=String(t.getHours()).padStart(2,"0"),Q=String(t.getMinutes()).padStart(2,"0"),X=String(t.getSeconds()).padStart(2,"0");return`${h}-${b}-${s} ${m}:${Q}:${X}`}const N=n=>{const[t,h,b]=n.split("/").map(Number),s=b.toString().padStart(2,"0"),m=h.toString().padStart(2,"0");return`${s}-${m}-${t}`},ke=()=>{const n=de.create();console.log(N(A.value),N(J.value)),n.get("http://localhost:5000/get-fact",{headers:{Authorization:j.value},params:{nit:"104909501",fechai:N(A.value),fechaf:N(J.value),tipo:"R"}}).then(t=>{const b=t.data.data.map(s=>({documento:s.numeroDocumento,serie:s.serie,fecha:s.fechaEmision,tipo:s.tipo,proveedor:s.nombreEmisor,nit:s.nitEmisor,total:s.granTotal,iva:s.totalIva}));p.value=b}).catch(t=>console.error("Error:",t))},De=n=>{p.value=p.value.filter(t=>t.documento!==n)},Te=()=>{p.value.push({documento:p.value.length+1})},Fe=ae(()=>p.value.reduce((n,t)=>n+parseFloat(t.total||0),0).toFixed(2)),Ne=ae(()=>p.value.reduce((n,t)=>n+parseFloat(t.iva||0),0).toFixed(2));function K(n){const t=n.replace(/[\$,]/g,"");return parseFloat(t)}return{onBuscarCompra:n=>{F.get("compras/idCompra",{params:{id_compra:n}}).then(t=>{console.log(t.data),l.value=n,k.value=t.data.enc.mes,v.value=t.data.enc.id_periodo,g.value=t.data.enc.id_cuenta_contable,c.value=t.data.enc.id_poliza,S.value=!0;let b=t.data.det.map(s=>({id:1,Cta:{id:s.id_cuenta,nombre:s.nombre,correlativo:s.correlativo},documento:s.doc_no,serie:s.serie,fecha:s.fecha,tipo:s.tipo_documento,proveedor:s.proveedor,nit:s.nit_cedula,checked:!1,Importacion:s.importaciones,Servicios:s.servicios,Exentos:s.exentos,Valor:s.valor,total:K(s.total),iva:K(s.iva)}));p.value=b})},file:M,parsedCSV:he,visibleDate:_e,fechai:A,fechaf:J,convert:ye,columns:Ce,compras:p,getdata:Se,getFacturas:ke,eliminarFila:De,agregarFila:Te,calculoTotal:Fe,calculoIva:Ne,onClick:we,selectedCuentaEnc:g,cuentasn4:y,getCuentasN4:$,cantFacturas:V,txtNoPartida:c,checkPartidaGenerada:S,txtNoCompra:l,mesesDelA\u00F1o:T,periodoModel:z,mesesModel:k,periodos:f,disableBTN:D,showBuscarCompra:r,refBuscadorCompra:e}},mounted(){this.getdata(),this.getCuentasN4()}}),W=e=>(be("data-v-24252612"),e=e(),ve(),e),We={class:"row q-col-gutter-sm"},Ke={class:"col-4"},Xe={class:"col-4"},Ze={class:"col-1"},ea={class:"col-4"},aa={class:"col-2"},la={class:"col-2 text-center"},oa={class:"col-3"},ta={class:"col-12"},sa={class:"col-12"},na={class:"row q-col-gutter-sm"},ra={class:"col-5"},ia={class:"row items-center justify-end"},da={class:"col-5"},ca={class:"row items-center justify-end"},ua={class:"col-2"},ma={class:"col-12"},pa={class:"row q-ma-sm"},fa=W(()=>i("div",{class:"col-9"},[i("div",{class:"text-h6"},"Detalle de Compras")],-1)),ba=W(()=>i("div",{class:"col-1"},null,-1)),va={class:"col"},ga=W(()=>i("strong",null,"Totales:",-1));function ha(e,r,y,g,V,S){const c=Be("buscador-compras");return pe(),fe(Je,{padding:""},{default:o(()=>[a(Ue,null,{default:o(()=>[a(G,{label:"Registros Contables",icon:"paid"}),a(G,{label:"Ingreso",icon:"input"}),a(G,{label:"Libro Compras",icon:"shopping_bag"})]),_:1}),a(L,{class:"q-mt-md"},{default:o(()=>[a(R,null,{default:o(()=>[i("div",We,[i("div",Ke,[a(I,{modelValue:e.txtNoCompra,"onUpdate:modelValue":r[0]||(r[0]=l=>e.txtNoCompra=l),type:"text",label:"No. Interno",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",Xe,[a(B,{modelValue:e.mesesModel,"onUpdate:modelValue":r[1]||(r[1]=l=>e.mesesModel=l),options:e.mesesDelA\u00F1o,label:"Mes",outlined:"",dense:"","option-value":"id","option-label":"nombre",disable:e.txtNoCompra!=null},null,8,["modelValue","options","disable"])]),i("div",Ze,[a(_,{color:"primary",outline:"",icon:"search",onClick:e.showBuscarCompra},null,8,["onClick"])]),i("div",ea,[a(B,{modelValue:e.selectedCuentaEnc,"onUpdate:modelValue":r[2]||(r[2]=l=>e.selectedCuentaEnc=l),options:e.cuentasn4,label:"Cuenta Haber",outlined:"",dense:"","option-value":"id","option-label":"nombre"},null,8,["modelValue","options"])]),i("div",aa,[a(I,{modelValue:e.cantFacturas,"onUpdate:modelValue":r[3]||(r[3]=l=>e.cantFacturas=l),type:"text",label:"Cant. Facturas",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",la,[a(oe,{"left-label":"",modelValue:e.checkPartidaGenerada,"onUpdate:modelValue":r[4]||(r[4]=l=>e.checkPartidaGenerada=l),label:"Partida generada",disable:!0},null,8,["modelValue"])]),i("div",oa,[a(I,{modelValue:e.txtNoPartida,"onUpdate:modelValue":r[5]||(r[5]=l=>e.txtNoPartida=l),type:"text",label:"No.Partida",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),i("div",ta,[a($e,{modelValue:e.visibleDate,"onUpdate:modelValue":r[6]||(r[6]=l=>e.visibleDate=l),label:"Consultar SAT"},null,8,["modelValue"])]),i("div",sa,[a(re,null,{default:o(()=>[E(i("div",na,[i("div",ra,[a(I,{dense:"",outlined:"",modelValue:e.fechai,"onUpdate:modelValue":r[8]||(r[8]=l=>e.fechai=l),mask:"date",rules:["date"],label:"Fecha Inicial","hide-bottom-space":"",placeholder:"YYYY/MM/DD",clearable:""},{append:o(()=>[a(H,{name:"event",class:"cursor-pointer"},{default:o(()=>[a(se,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:o(()=>[a(ne,{modelValue:e.fechai,"onUpdate:modelValue":r[7]||(r[7]=l=>e.fechai=l)},{default:o(()=>[i("div",ia,[E(a(_,{label:"Cerrar",color:"primary",flat:""},null,512),[[ie]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),i("div",da,[a(I,{dense:"",outlined:"",modelValue:e.fechaf,"onUpdate:modelValue":r[10]||(r[10]=l=>e.fechaf=l),mask:"date",rules:["date"],"hide-bottom-space":"",label:"Fecha Final",placeholder:"YYYY/MM/DD",clearable:""},{append:o(()=>[a(H,{name:"event",class:"cursor-pointer"},{default:o(()=>[a(se,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:o(()=>[a(ne,{modelValue:e.fechaf,"onUpdate:modelValue":r[9]||(r[9]=l=>e.fechaf=l)},{default:o(()=>[i("div",ca,[E(a(_,{label:"Cerrar",color:"primary",flat:""},null,512),[[ie]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),i("div",ua,[a(_,{color:"primary",label:"Consultar",onClick:e.getFacturas},null,8,["onClick"])])],512),[[te,e.visibleDate]])]),_:1})]),i("div",ma,[a(re,null,{default:o(()=>[E(a(Ae,{modelValue:e.file,"onUpdate:modelValue":[r[11]||(r[11]=l=>e.file=l),e.convert],label:"Seleccione o arraste un archivo para importar(.xls)",outlined:"",accept:".xls",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),[[te,!e.visibleDate]])]),_:1})])])]),_:1})]),_:1}),a(L,{class:"q-mt-sm"},{default:o(()=>[a(R,{class:"q-pt-none"},{default:o(()=>[i("div",pa,[fa,ba,i("div",va,[a(_,{color:"primary",icon:"check",label:e.txtNoCompra?"Actualizar Partida":"Generar Partida",onClick:e.onClick,disable:e.disableBTN},null,8,["label","onClick","disable"])])]),a(ge,{style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",rows:e.compras,columns:e.columns,"row-key":"id",dense:""},{"body-cell-Tipo":o(l=>[a(u,{props:l},{default:o(()=>[a(B,{modelValue:l.row.tipo,"onUpdate:modelValue":v=>l.row.tipo=v,options:[{label:"Factura",value:"FACT"},{label:"Cambiaria",value:"FCAM"},{label:"NC",value:"NCRE"}],borderless:"",dense:"","options-dense":"","map-options":"",class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell":o(l=>[a(u,{props:l},{default:o(()=>[a(I,{modelValue:l.row[l.col.field],"onUpdate:modelValue":v=>l.row[l.col.field]=v,"input-class":"text-right",dense:"",borderless:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-Cta":o(l=>[a(u,{props:l},{default:o(()=>[a(B,{modelValue:l.row.Cta,"onUpdate:modelValue":v=>l.row.Cta=v,options:e.cuentasn4,borderless:"",dense:"","options-dense":"","use-input":"","input-debounce":"0",class:"custom-select","option-value":"id","option-label":"nombre",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1032,["props"])]),"body-cell-check":o(l=>[a(u,{props:l,align:"center"},{default:o(()=>[a(oe,{modelValue:l.row.checked,"onUpdate:modelValue":v=>l.row.checked=v,color:"primary",dense:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-acciones":o(l=>[a(u,{props:l},{default:o(()=>[a(_,{flat:"",round:"",icon:"delete",color:"negative",onClick:v=>e.eliminarFila(l.row.documento)},null,8,["onClick"])]),_:2},1032,["props"])]),"bottom-row":o(()=>[a(O,null,{default:o(()=>[a(u,{colspan:"7",class:"text-right"}),a(u,{class:"text-right"},{default:o(()=>[ga]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoTotal),1)]),_:1}),a(u,{class:"text-right"},{default:o(()=>[i("strong",null,C(e.calculoIva),1)]),_:1})]),_:1})]),bottom:o(l=>[a(O,{props:l},{default:o(()=>[a(u,{colspan:"100%"},{default:o(()=>[a(_,{flat:"",icon:"add",label:"Agregar Fila",onClick:e.agregarFila},null,8,["onClick"])]),_:1})]),_:2},1032,["props"])]),"no-data":o(l=>[a(O,{props:l},{default:o(()=>[a(u,{colspan:"100%"},{default:o(()=>[a(_,{flat:"",icon:"add",label:"Agregar Fila",onClick:e.agregarFila},null,8,["onClick"])]),_:1})]),_:2},1032,["props"])]),_:1},8,["rows","columns"])]),_:1})]),_:1}),a(c,{ref:"refBuscadorCompra",onCompraSeleccionada:e.onBuscarCompra},null,8,["onCompraSeleccionada"])]),_:1})}var Ua=me(xe,[["render",ha],["__scopeId","data-v-24252612"]]);export{Ua as default};
