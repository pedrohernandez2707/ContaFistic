import{a as R,Q as Te}from"./QBreadcrumbs.77656000.js";import{d as fe,g as c,_ as ge,o as F,aF as he,w as i,e as o,l as N,i as Z,j as E,C as X,aG as ne,aH as ee,Q as ae,aM as Pe,bp as $e,bq as ze,f as u,q as se,r as Ue,P as K,a as z,bl as Ae,ba as Le,x as U,aq as re,c as A,aJ as ie,aK as de}from"./index.03b32b94.js";import{h as W}from"./QSelect.6c525bb7.js";import{r as xe,u as Je,Q as ue,a as ce,b as qe}from"./xlsx.69a6666e.js";import{Q as pe,C as me}from"./ClosePopup.172973a0.js";import{Q as Ve,a as oe}from"./QTable.5f86a8ee.js";import{Q as je}from"./QPage.e7dfedc0.js";import{a as M,s as V,c as ve,b as Oe}from"./axios.1ea36c68.js";import{Q as Ye,a as Ge}from"./QBar.9c1aa244.js";import"./selection.16f4a865.js";import"./use-render-cache.3aae9b27.js";import"./QList.75b10340.js";const He=fe({name:"BuscadorVentas",emits:["venta-seleccionada"],setup(e,{emit:s}){const _=c(null),h=c(!1),C=c(""),Q=[{name:"empresa",label:"Empresa",align:"left",field:"nombre_empresa",sortable:!0},{name:"venta",label:"Venta",align:"left",field:"id_venta",sortable:!0},{name:"poliza",label:"Poliza",align:"left",field:"id_poliza",sortable:!0},{name:"descripcion",label:"Descripci\xF3n",align:"left",field:"descripcion",sortable:!0}],m=c([]),l=c([...m.value]),f=()=>{C.value===null?l.value=m.value:l.value=m.value.filter(b=>b.id_compra.toLowerCase().includes(C.value)||b.descripcion||b.nombre_empresa||b.id_poliza.toLowerCase().includes(C.value.toLowerCase()))},L=(b,S)=>{h.value=!1,s("venta-seleccionada",S.id_venta)},x=()=>{h.value=!1},J=async()=>{var b;h.value=!0,await new Promise(S=>setTimeout(S,250)),(b=_.value)==null||b.focus(),q()},q=()=>{M.get("ventas",{params:{id_empresa:3,id_periodo:1}}).then(b=>{m.value=b.data,l.value=b.data})};return{refInputBuscar:_,dialogVisible:h,searchQuery:C,columns:Q,ventas:m,filteredVentas:l,filtrarVentas:f,seleccionarVenta:L,cerrarDialogo:x,abrirDialogo:J}}}),Re=e=>($e("data-v-473e3052"),e=e(),ze(),e),Ke=Re(()=>u("div",{class:"text-h6"},"Buscador",-1));function We(e,s,_,h,C,Q){return F(),he(Pe,{modelValue:e.dialogVisible,"onUpdate:modelValue":s[1]||(s[1]=m=>e.dialogVisible=m),persistent:""},{default:i(()=>[o(ae,{style:{"min-width":"650px"}},{default:i(()=>[o(Ye,null,{default:i(()=>[Ke,o(Ge),o(N,{dense:"",flat:"",icon:"close",onClick:e.cerrarDialogo},null,8,["onClick"])]),_:1}),o(Z,null,{default:i(()=>[o(E,{modelValue:e.searchQuery,"onUpdate:modelValue":[s[0]||(s[0]=m=>e.searchQuery=m),e.filtrarVentas],ref:"refInputBuscar",label:"Buscar Libro Ventas",dense:"",outlined:"",clearable:"",debounce:"350"},{append:i(()=>[o(X,{name:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),o(Ve,{rows:e.filteredVentas,columns:e.columns,"row-key":"correlativo",style:{height:"400px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",onRowDblclick:e.seleccionarVenta,dense:""},{"body-cell-correlativo":i(m=>[o(oe,{props:m},{default:i(()=>[ne(ee(m.row.correlativo),1)]),_:2},1032,["props"])]),"body-cell-nombre":i(m=>[o(oe,{props:m},{default:i(()=>[ne(ee(m.row.nombre),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","onRowDblclick"])]),_:1})]),_:1},8,["modelValue"])}var Ze=ge(He,[["render",We],["__scopeId","data-v-473e3052"]]);const B=new Date;B.getDate();B.getMonth()+1;B.getFullYear();B.setHours(0,-B.getTimezoneOffset(),0,0);let be=B.toJSON().slice(0,10).replaceAll("-","/");const Xe=fe({components:{BuscadorVentas:Ze},setup(){const e=c(null),s=()=>{var t;(t=e.value)==null||t.abrirDialogo()},_=c([]),h=c([]),C=c(null),Q=c(""),m=c(!1),l=c(""),f=c(null),L=()=>{f.value=null,M.get("/cuentasn4/combo").then(t=>{_.value=t.data})},x=(t,a)=>{if(t===""){a(()=>{h.value=[..._.value]});return}const p=t.toLowerCase();a(()=>{h.value=_.value.filter(d=>d.descripcion.toLowerCase().includes(p))})},J=(t,a)=>{if(t===""){a(()=>{h.value=_.value});return}a(()=>{const p=t.toLowerCase();h.value=_.value.filter(d=>isNaN(p)?d.descripcion.toLowerCase().includes(p.toLowerCase()):d.descripcion.toLowerCase().startsWith(p.toString()))},p=>{t!==""&&p.options.length>0&&(p.setOptionIndex(-1),p.moveOptionSelection(1,!0))})},q=c(null),b=c(null),S=c(!1),_e=c([{id:1,nombre:"2024"}]),Ce=c([{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}]),I=c(null),we=c([]),Se=c(!1),j=c(be),O=c(be),g=c([{}]),ye=[{name:"Doc",label:"Doc. No",field:"documento",align:"left"},{name:"Serie",label:"Serie",field:"serie",align:"left"},{name:"Fecha",label:"Fecha",field:"fecha",align:"left",sortable:!0},{name:"Tipo",label:"Tipo",field:"tipo",align:"left",style:"max-width:120px;width:100px;"},{name:"NIT",label:"NIT",field:"nit",align:"left",style:"min-width:100px;width:100px"},{name:"Comprador",label:"Comprador",field:"comprador",align:"left",style:"max-width:290px;width:290px;text-wrap:balance"},{name:"Cta",label:"Cta",field:"Cta",align:"left",style:"max-width:150px;width:150px"},{name:"Exportaciones",label:"Exportaciones",field:"exportaciones",align:"left"},{name:"Bienes",label:"Bienes",field:"bienes",align:"left"},{name:"Servicios",label:"Servicios",field:"servicios",align:"left"},{name:"Exentos",label:"Exentos",field:"Exentos",align:"left"},{name:"SubTotal",label:"SubTotal",field:"subtotal",align:"left"},{name:"Iva",label:"Iva",field:"iva",align:"left"}],De=t=>{g.value=g.value.filter(a=>a.documento!==t)},Ie=()=>{g.value.push({documento:g.value.length+1})};function te(t){const a=new Date(t),p=a.getFullYear(),d=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),w=String(a.getHours()).padStart(2,"0"),y=String(a.getMinutes()).padStart(2,"0"),P=String(a.getSeconds()).padStart(2,"0");return`${p}-${d}-${n} ${w}:${y}:${P}`}const Fe=async()=>{var t,a;if(I.value){const p=(a=(t=b.value)==null?void 0:t.id)!=null?a:null;let d=JSON.parse(K.getItem("empresa").toString());if(!d){V("Debe Seleccionar la Empresa",{tipo:"negative"}),I.value=null;return}if(!p){V("Debe Seleccionar el Mes",{tipo:"negative"}),I.value=null;return}const n=await I.value.arrayBuffer(),w=xe(n),y=w.Sheets[w.SheetNames[0]],P=Je.sheet_to_json(y);let k="",r="";d!==null&&(k=d.nit,r=d.distVentas);let D=!1;const G=P.filter(v=>{const H=te(v["Fecha de emisi\xF3n"]).toString();if(parseInt(H.split("-")[1])!==p)return V("Existen documentos con una fecha que no corresponde al mes seleccionado. Verifique el archivo.",{tipo:"negative",timeout:8500,progress:!0}),D=!0,I.value=null,!1;if(k!==v["ID del receptor"])return v;V("Existen documentos con el mismo nit de la empresa seleccionada, verifique si no esta intentando cargar un archivo de compras!",{tipo:"negative",timeout:8500,progress:!0})});if(D)return;const $=G.map(v=>({documento:v["N\xFAmero del DTE"],serie:v.Serie,fecha:te(v["Fecha de emisi\xF3n"]),tipo:v["Tipo de DTE (nombre)"],nit:v["ID del receptor"],comprador:v["Nombre completo del receptor"],bienes:r==="Bienes"?v["Monto (Gran Total)"]:"",servicios:r==="Servicios"?v["Monto (Gran Total)"]:"",subtotal:(v["Monto (Gran Total)"]-v["IVA (monto de este impuesto)"]).toFixed(2),iva:v["IVA (monto de este impuesto)"],Cta:{id:d.id_cuenta,nombre:d.distribucion,correlativo:"",descripcion:d.desc_cuenta}}));g.value=$}return 0},Y=c("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZ2VuY2lhVmlydHVhbERURSIsImlzcyI6IlNBVCIsIm5pdCI6IjEwNDkwOTUwMSIsImV4cCI6MTcyNDc3MjU3NiwiaWF0IjoxNzI0NzI5Mzc2fQ.1h1lDjyLsrL7ZH9inMvVZ9PHV-xtBsN6qVdPK0uHB54"),Ne=()=>{const t=ve.create();Y.value===""&&t.get("http://localhost:5000/get-token").then(a=>{console.log(a.data),Y.value=a.data}).catch(a=>console.error("Error:",a))},T=t=>{const[a,p,d]=t.split("/").map(Number),n=d.toString().padStart(2,"0"),w=p.toString().padStart(2,"0");return`${n}-${w}-${a}`},Ee=()=>{const t=ve.create();console.log(T(j.value),T(O.value)),t.get("http://localhost:5000/get-fact",{headers:{Authorization:Y.value},params:{nit:"104909501",fechai:T(j.value),fechaf:T(O.value),tipo:"R"}}).then(a=>{const d=a.data.data.map(n=>({documento:n.numeroDocumento,serie:n.serie,fecha:n.fechaEmision,tipo:n.tipo,proveedor:n.nombreEmisor,nit:n.nitEmisor,total:n.granTotal,iva:n.totalIva}));console.log(d),g.value=d}).catch(a=>console.error("Error:",a))},Be=t=>t.every(a=>a.Cta!==null),Qe=async()=>{let t=!1;const a=JSON.parse(K.getItem("empresa").toString());let p=0;if(a)p=a.id;else{V("Debe Seleccionar Empresa",{tipo:"negative"}),t=!0;return}const d=b.value;if(!d){V("Debe Seleccionar el Mes",{tipo:"negative"}),t=!0;return}let n=C.value;if(!n){V("Debe Seleccionar la Cuenta Contable Para el Encabezado",{tipo:"negative"}),t=!0;return}if(g.value.length==0){V("Debe Ingresar al Menos un Detalle",{tipo:"negative"}),t=!0;return}if(!Be(g.value)){V("Debe Indicar la cuenta contable para cada uno de los Detalles, verificar",{tipo:"negative"}),t=!0;return}let w=K.getItem("periodo");if(!w){V("Debe Seleccionar el Periodo para la Empresa Correspondiente",{tipo:"negative"}),t=!0;return}if(!t){let y=f.value;if(!await Oe("Confirmaci\xF3n","Esta seguro de "+(y!==null&&y!==""?"Actualizar libro de Ventas: "+y:"Insertar al libro de Ventas?"),{}))return;const k=g.value.map(r=>({id:r.id,Cta:r.Cta,documento:r.documento,serie:r.serie,fecha:r.fecha,tipo:r.tipo,proveedor:r.proveedor,nit:r.nit,Importacion:r.Importacion,Servicios:r.Servicios,Exentos:r.Exentos,Valor:r.Valor,iva:r.iva,total:(isNaN(parseFloat(r.servicios))?0:parseFloat(r.servicios))+(isNaN(parseFloat(r.bienes))?0:parseFloat(r.bienes))}));if(f.value!=null){const r={_encabezado:[{_id_venta:f.value,_p_id_poliza:l.value,_id_cuenta_contable:n&&n.id?n.id:n,_usuario_ingresa:"usrtest",_estado:"A",_mes:b.value}],_detalle:k};console.log(r),z.show(),await M.put("/ventas",r).then(D=>{console.log(D.data),V("Venta actualizada correctamente, Partida Actualizada",{}),S.value=!0}).finally(()=>{z.hide()})}else{const r={_encabezado:[{_id_Empresa:p,_mes:(d==null?void 0:d.id)||0,_periodo:w,_id_poliza:0,_id_cuenta_contable:n.id,_usuario_ingresa:"usrtest",_estado:"A"}],_detalle:k};console.log(r),z.show(),await M.post("/ventas",r).then(D=>{console.log(D.data);const G=D.data.fn_insertar_ventas_json,[$,v]=G.replace(/[()]/g,"").split(","),H=parseInt($);v.replace(/"/g,""),V(`Venta guardada correctamente No.${$} Partida Generada ${v}`,{}),f.value=H.toString(),l.value=v.toString(),m.value=!0,S.value=!0}).finally(()=>{z.hide()})}}},ke=se(()=>g.value.reduce((t,a)=>t+parseFloat(a.total||0),0).toFixed(2)),Me=se(()=>g.value.reduce((t,a)=>t+parseFloat(a.iva||0),0).toFixed(2));function le(t){const a=t.replace(/[\$,]/g,"");return parseFloat(a)}return{filterCuentas:x,file:I,parsedCSV:we,visibleDate:Se,fechai:j,fechaf:O,convert:Fe,columns:ye,ventas:g,getdata:Ne,getFacturas:Ee,eliminarFila:De,agregarFila:Ie,calculoTotal:ke,calculoIva:Me,selectedCuentaEnc:C,cuentasn4:_,cuentasFilter:h,filterCuenta:J,getCuentasN4:L,cantFacturas:Q,txtNoPartida:l,checkPartidaGenerada:m,txtNoVenta:f,mesesDelA\u00F1o:Ce,periodoModel:q,mesesModel:b,periodos:_e,disableBTN:S,onClick:Qe,onBuscarVenta:t=>{M.get("ventas/idVenta",{params:{id_venta:t}}).then(a=>{console.log(a.data),f.value=t,b.value=a.data.enc.mes,C.value=a.data.enc.id_cuenta_contable,l.value=a.data.enc.id_poliza;let d=a.data.det.map(n=>({id:1,Cta:{id:n.id_cuenta,correlativo:n.correlativo,nombre:n.nombre,descripcion:n.correlativo+" "+n.nombre},documento:n.doc_no,serie:n.serie,fecha:n.fecha,tipo:n.tipo_documento,proveedor:n.proveedor,nit:n.nit_cedula,checked:!1,Importacion:n.importaciones,Servicios:n.servicios,Exentos:n.exentos,Valor:n.valor,total:le(n.total),iva:le(n.iva)}));g.value=d})},refBuscadorVentas:e,showBuscarVentas:s}},mounted(){this.getCuentasN4(),this.getdata()}}),ea={class:"row q-col-gutter-sm"},aa={class:"col-4"},oa={class:"col-4"},ta={class:"col-1"},la={class:"col-4"},na={class:"col-2"},sa={class:"col-3 text-right"},ra={class:"col-3"},ia={class:"col-12"},da={class:"col-12"},ua={class:"row q-col-gutter-sm"},ca={class:"col-5"},pa={class:"row items-center justify-end"},ma={class:"col-5"},va={class:"row items-center justify-end"},ba={class:"col-2"},fa={class:"col-12"},ga={class:"row q-ma-sm"},ha=u("div",{class:"col-9"},[u("div",{class:"text-h6"},"Detalle de Ventas")],-1),Va=u("div",{class:"col-1"},null,-1),_a={class:"col"},Ca={class:"table table-bordered",id:"preview-table"};function wa(e,s,_,h,C,Q){const m=Ue("buscador-ventas");return F(),he(je,{padding:""},{default:i(()=>[o(Te,null,{default:i(()=>[o(R,{label:"Registros Contables",icon:"home"}),o(R,{label:"Ingreso",icon:"widgets"}),o(R,{label:"Libro Ventas",icon:"navigation"})]),_:1}),o(ae,{class:"q-mt-md"},{default:i(()=>[o(Z,null,{default:i(()=>[u("div",ea,[u("div",aa,[o(E,{modelValue:e.txtNoVenta,"onUpdate:modelValue":s[0]||(s[0]=l=>e.txtNoVenta=l),type:"text",label:"No. Interno",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),u("div",oa,[o(W,{modelValue:e.mesesModel,"onUpdate:modelValue":s[1]||(s[1]=l=>e.mesesModel=l),options:e.mesesDelA\u00F1o,label:"Mes",outlined:"",dense:"","option-value":"id","option-label":"nombre",disable:e.txtNoVenta!=null},null,8,["modelValue","options","disable"])]),u("div",ta,[o(N,{color:"primary",outline:"",icon:"search",onClick:e.showBuscarVentas},null,8,["onClick"])]),u("div",la,[o(W,{modelValue:e.selectedCuentaEnc,"onUpdate:modelValue":s[2]||(s[2]=l=>e.selectedCuentaEnc=l),options:e.cuentasFilter,label:"Cuenta Debe",outlined:"",dense:"","option-value":"id","option-label":"descripcion","use-input":"","input-debounce":"300",onFilter:e.filterCuentas,clearable:""},null,8,["modelValue","options","onFilter"])]),u("div",na,[o(E,{modelValue:e.cantFacturas,"onUpdate:modelValue":s[3]||(s[3]=l=>e.cantFacturas=l),type:"text",label:"Cant. Facturas",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),u("div",sa,[o(Ae,{"left-label":"",modelValue:e.checkPartidaGenerada,"onUpdate:modelValue":s[4]||(s[4]=l=>e.checkPartidaGenerada=l),label:"Partida generada",disable:!0},null,8,["modelValue"])]),u("div",ra,[o(E,{modelValue:e.txtNoPartida,"onUpdate:modelValue":s[5]||(s[5]=l=>e.txtNoPartida=l),type:"text",label:"No.Partida",outlined:"",dense:"",disable:!0},null,8,["modelValue"])]),u("div",ia,[o(Le,{modelValue:e.visibleDate,"onUpdate:modelValue":s[6]||(s[6]=l=>e.visibleDate=l),label:"Consultar SAT"},null,8,["modelValue"])]),u("div",da,[o(pe,null,{default:i(()=>[U(u("div",ua,[u("div",ca,[o(E,{dense:"",outlined:"",modelValue:e.fechai,"onUpdate:modelValue":s[8]||(s[8]=l=>e.fechai=l),mask:"date",rules:["date"],label:"Fecha Inicial","hide-bottom-space":"",placeholder:"YYYY/MM/DD",clearable:""},{append:i(()=>[o(X,{name:"event",class:"cursor-pointer"},{default:i(()=>[o(ue,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:i(()=>[o(ce,{modelValue:e.fechai,"onUpdate:modelValue":s[7]||(s[7]=l=>e.fechai=l)},{default:i(()=>[u("div",pa,[U(o(N,{label:"Cerrar",color:"primary",flat:""},null,512),[[me]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),u("div",ma,[o(E,{dense:"",outlined:"",modelValue:e.fechaf,"onUpdate:modelValue":s[10]||(s[10]=l=>e.fechaf=l),mask:"date",rules:["date"],"hide-bottom-space":"",label:"Fecha Final",placeholder:"YYYY/MM/DD",clearable:""},{append:i(()=>[o(X,{name:"event",class:"cursor-pointer"},{default:i(()=>[o(ue,{cover:"","transition-show":"scale","transition-hide":"scale"},{default:i(()=>[o(ce,{modelValue:e.fechaf,"onUpdate:modelValue":s[9]||(s[9]=l=>e.fechaf=l)},{default:i(()=>[u("div",va,[U(o(N,{label:"Cerrar",color:"primary",flat:""},null,512),[[me]])])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),u("div",ba,[o(N,{color:"primary",label:"Consultar",onClick:e.getFacturas},null,8,["onClick"])])],512),[[re,e.visibleDate]])]),_:1})]),u("div",fa,[o(pe,null,{default:i(()=>[U(o(qe,{modelValue:e.file,"onUpdate:modelValue":[s[11]||(s[11]=l=>e.file=l),e.convert],label:"Seleccione o arraste un archivo para importar(.xls)",outlined:"",accept:".xls",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),[[re,!e.visibleDate]])]),_:1})])])]),_:1})]),_:1}),o(ae,{class:"q-mt-sm"},{default:i(()=>[o(Z,null,{default:i(()=>[u("div",ga,[ha,Va,u("div",_a,[o(N,{color:"primary",icon:"check",label:e.txtNoVenta?"Actualizar Partida":"Generar Partida",onClick:e.onClick,disable:e.disableBTN},null,8,["label","onClick","disable"])])]),o(Ve,{style:{height:"500px"},flat:"",bordered:"","virtual-scroll":"",separator:"cell","rows-per-page-options":[0],class:"my-sticky-header-table",rows:e.ventas,columns:e.columns,"row-key":"id",dense:""},{"body-cell-Cta":i(l=>[o(oe,{props:l},{default:i(()=>[o(W,{modelValue:l.row.Cta,"onUpdate:modelValue":f=>l.row.Cta=f,options:e.cuentasFilter,"option-label":"descripcion","option-value":"id",dense:"",borderless:"","map-options":"","hide-selected":"","hide-bottom-space":"","use-input":"","fill-input":"",clearable:"",onFilter:e.filterCuenta,onFilterAbort:()=>{}},null,8,["modelValue","onUpdate:modelValue","options","onFilter"])]),_:2},1032,["props"])]),_:1},8,["rows","columns"]),u("table",Ca,[u("tbody",null,[(F(!0),A(de,null,ie(e.parsedCSV,l=>(F(),A("tr",null,[(F(!0),A(de,null,ie(l,f=>(F(),A("td",null,ee(f),1))),256))]))),256))])])]),_:1})]),_:1}),o(m,{ref:"refBuscadorVentas",onVentaSeleccionada:e.onBuscarVenta},null,8,["onVentaSeleccionada"])]),_:1})}var za=ge(Xe,[["render",wa]]);export{za as default};
